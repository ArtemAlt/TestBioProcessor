name: Build and Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build APK and Create Release
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # –®–∞–≥ 3: üîê –°–û–ó–î–ê–¢–¨ –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ –ò–ó SECRETS
      - name: Setup certificates from Secrets
        run: |
          mkdir -p app/src/main/assets/certs
          echo "${{ secrets.CLIENT_CRT_BASE64 }}" | base64 --decode > app/src/main/assets/certs/client.crt
          echo "${{ secrets.CLIENT_KEY_BASE64 }}" | base64 --decode > app/src/main/assets/certs/client.key
          
          # –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–ª–∏—Å—å
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ certs:"
          ls -la app/src/main/assets/certs/
          echo "üìÑ –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"
          head -c 100 app/src/main/assets/certs/client.crt
          echo ""
          echo "üîë –ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ –∫–ª—é—á–∞:"
          head -c 50 app/src/main/assets/certs/client.key
          echo ""

      # –®–∞–≥ 4: –°–æ–±—Ä–∞—Ç—å APK —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º BASE_URL
      - name: Build APK with custom BASE_URL
        run: |
          ./gradlew assembleDebug -PbaseUrl="${{ secrets.BASE_URL }}"

      # –®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏
      - name: Get version info
        id: version
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "DATE=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      # –®–∞–≥ 6: –°–æ–∑–¥–∞—Ç—å Release –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å APK
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## üöÄ TestBioProcessor ${{ github.ref_name }}
            
            ### üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:
            - –í–µ—Ä—Å–∏—è: **${{ github.ref_name }}**
            - API URL: `${{ secrets.BASE_URL }}`
            - –ö–æ–º–º–∏—Ç: ${{ steps.version.outputs.SHORT_SHA }}
            - –°–æ–±—Ä–∞–Ω–æ: ${{ steps.version.outputs.DATE }}
            - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã: –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Secrets üîê
            
            ### üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –Ω–∏–∂–µ
            2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            
            ---
            *–°–æ–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å GitHub Actions*
          draft: false
          prerelease: false
          files: |
            app/build/outputs/apk/debug/app-debug.apk
          asset_name: TestBioProcessor-${{ github.ref_name }}.apk